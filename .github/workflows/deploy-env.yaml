name: Deploy - Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: 'Environment to deploy to'
        required: true
        default: 'Test'
        options:
          - 'Test'
          - 'Staging'
      clear-cache:
        type: choice
        description: 'Clear the cache?'
        required: true
        default: 'False'
        options:
          - 'True'
          - 'False'
  release:
    types: [ published ]

run-name: Deploy to ${{ github.event.inputs.environment || 'Production' }}

jobs:
  package:
    name: 'Package Web in Docker'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./src
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.set_tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Set Docker image tag
        id: set_tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "Using Git tag for versioning: ${{ github.ref_name }}"
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "Using commit SHA for versioning: ${{ github.sha }}"
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Web Docker Image
        run: |
          docker build . -t ghcr.io/${{ env.REPO }}:${{ steps.set_tag.outputs.tag }} -f web/CareLeavers.Web/Dockerfile

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Web Docker Image
        run: docker push ghcr.io/${{ env.REPO }}:${{ steps.set_tag.outputs.tag }}

  deploy_environment:
    # This name is dynamic and will update based on the determined environment
    name: Deploying site to ${{ needs.package.outputs.environment || 'Production' }}
    runs-on: ubuntu-latest
    needs: [ package ]
    permissions:
      contents: read
      id-token: write
    # The environment name is now set dynamically in a later step
    environment:
      name: ${{ steps.vars.outputs.environment }}
    env:
      ARM_CLIENT_ID: "${{ secrets.AZURE_CLIENT_ID }}"
      ARM_SUBSCRIPTION_ID: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
      ARM_TENANT_ID: "${{ secrets.AZURE_TENANT_ID }}"
      ARM_CLIENT_SECRET: "${{ secrets.AZURE_CLIENT_SECRET }}"

    steps:
      - name: Set dynamic variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "Triggered by release. Parsing release body for options."
            BODY="${{ github.event.release.body }}"
            # Extract values, trim whitespace, and provide defaults
            ENV_VALUE=$(echo "$BODY" | grep 'environment:' | awk -F': ' '{print $2}' | tr -d '[:space:]')
            CACHE_VALUE=$(echo "$BODY" | grep 'clear-cache:' | awk -F': ' '{print $2}' | tr -d '[:space:]')
            echo "environment=${ENV_VALUE:-Production}" >> $GITHUB_OUTPUT
            echo "clear_cache=${CACHE_VALUE:-False}" >> $GITHUB_OUTPUT
          else
            echo "Triggered manually. Using workflow dispatch inputs."
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "clear_cache=${{ github.event.inputs.clear-cache }}" >> $GITHUB_OUTPUT
          fi

      - name: Display Determined Variables
        run: |
          echo "Deployment Environment: ${{ steps.vars.outputs.environment }}"
          echo "Clear Cache: ${{ steps.vars.outputs.clear_cache }}"

      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          terraform_version: 1.10.4

      - name: 'Az CLI login'
        uses: azure/login@v2
        with:
          creds: |
            {
                "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
                "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
                "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
                "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Create TF State dependencies
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az group create --name s186${{ vars.ENVIRONMENT_PREFIX }}-cl-tfstate --location westeurope --output none --tags "Environment=${{ vars.CIP_ENVIRONMENT }}" "Product=Design Operations" "Service=Newly onboarded" "Service offering=Design operations"

            az storage account create --name s186${{ vars.ENVIRONMENT_PREFIX }}cltfstate --resource-group s186${{ vars.ENVIRONMENT_PREFIX }}-cl-tfstate --location westeurope --sku Standard_LRS

            az storage container create --name tfstate --account-name s186${{ vars.ENVIRONMENT_PREFIX }}cltfstate

      - name: 'Terraform Init'
        id: terraform_init
        working-directory: ./src/infrastructure/terraform
        run: terraform init -backend-config="resource_group_name=s186${{ vars.ENVIRONMENT_PREFIX }}-cl-tfstate" -backend-config="storage_account_name=s186${{ vars.ENVIRONMENT_PREFIX }}cltfstate" -backend-config="container_name=tfstate" -backend-config="key=terraform.tfstate"

      - name: 'Terraform Plan'
        id: terraform_plan
        working-directory: ./src/infrastructure/terraform
        run: terraform plan -out plan.plan
        env:
          # MODIFIED: Uses the output from the 'vars' step
          TF_VAR_aspnetcore_environment: ${{ steps.vars.outputs.environment }}
          TF_VAR_environment_prefix: ${{ vars.ENVIRONMENT_PREFIX }}
          TF_VAR_cip_environment: ${{ vars.CIP_ENVIRONMENT }}
          TF_VAR_contentful_delivery_api_key: ${{ secrets.CONTENTFUL_DELIVERY_API_KEY }}
          TF_VAR_contentful_preview_api_key: ${{ secrets.CONTENTFUL_PREVIEW_API_KEY }}
          TF_VAR_contentful_management_api_key: ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }}
          TF_VAR_contentful_space_id: ${{ secrets.CONTENTFUL_SPACE_ID }}
          TF_VAR_contentful_environment: ${{ vars.CONTENTFUL_ENVIRONMENT }}
          TF_VAR_contentful_use_preview_api: ${{ vars.CONTENTFUL_PREVIEW }}
          TF_VAR_caching_type: ${{ vars.CACHING_TYPE }}
          TF_VAR_scripts_clarity: ${{ vars.SCRIPTS_CLARITY }}
          TF_VAR_custom_domain: ${{ vars.CUSTOM_DOMAIN }}
          TF_VAR_azure_translation_document_endpoint: ${{ vars.AZURE_TRANSLATION_DOCUMENT_ENDPOINT }}
          TF_VAR_azure_translation_access_key: ${{ secrets.AZURE_TRANSLATION_ACCESS_KEY }}
          TF_VAR_azure_frontdoor_scale: ${{ vars.AZURE_FRONTDOOR_SCALE }}
          TF_VAR_pdf_generation_api_key: ${{ secrets.PDF_GENERATION_API_KEY }}
          TF_VAR_pdf_generation_use_sandbox: ${{ vars.PDF_GENERATION_USE_SANDBOX }}
          TF_VAR_rebrand: ${{ vars.REBRAND }}
          TF_VAR_support_alert_email: ${{ secrets.SUPPORT_ALERT_EMAIL }}

      - name: 'Terraform Apply'
        id: terraform_apply
        working-directory: ./src/infrastructure/terraform
        run: terraform apply plan.plan

      - name: Lowercase the repo name and username
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: s186${{ vars.ENVIRONMENT_PREFIX }}-cl-web-app-service
          slot-name: 'staging'
          images: 'ghcr.io/${{ env.REPO }}:${{ needs.package.outputs.image_tag }}'

      - name: Swap slot to production
        run: az webapp deployment slot swap --name s186${{ vars.ENVIRONMENT_PREFIX }}-cl-web-app-service --resource-group s186${{ vars.ENVIRONMENT_PREFIX }}-cl-web-rg --slot staging --target-slot production

      - name: Delete staging slot
        run: az webapp deployment slot delete --name s186${{ vars.ENVIRONMENT_PREFIX }}-cl-web-app-service --resource-group s186${{ vars.ENVIRONMENT_PREFIX }}-cl-web-rg --slot staging

      - name: Clear Cache
        id: clear-cache
        uses: fjogeleit/http-request-action@v1
        # MODIFIED: Uses the output from the 'vars' step
        if: ${{ steps.vars.outputs.clear_cache == 'True' }}
        with:
          url: 'https://${{ vars.CUSTOM_DOMAIN }}/b0e0dce2-b96d-4b94-a800-63c3ab56e72f'
          method: 'POST'